# name: test/sql/queries/multi_catalog_schemas.test_slow
# description: Test multi-catalog auto-discovery when no database is specified
# group: [queries]

# Tests in this file require a running Flight SQL server
# Run: ./scripts/test-servers.sh start before executing

require duckhog

require-env FLIGHT_HOST

require-env FLIGHT_PORT

# When no catalog is specified in the connection string, the extension
# auto-discovers all remote catalogs from the Flight server.
# DuckDB typically exposes multiple catalogs (e.g. "memory", "system", "temp").
# All discovered catalogs use the prefix pattern: <alias>_<catalog_name>
statement ok
ATTACH 'hog:?token=demo&flight_server=grpc://${FLIGHT_HOST}:${FLIGHT_PORT}' AS remote;

# Verify remote_memory has the 'main' schema
query I
SELECT COUNT(*) FROM information_schema.schemata WHERE catalog_name = 'remote_memory' AND schema_name = 'main';
----
1

# Verify remote_system has the 'main' schema
query I
SELECT COUNT(*) FROM information_schema.schemata WHERE catalog_name = 'remote_system' AND schema_name = 'main';
----
1

# Ensure the primary data catalog has working table access
query I
SELECT COUNT(*) FROM remote_memory.main.numbers;
----
10

# The primary alias 'remote' is a stub catalog with no tables.
# Verify it has no schemas in information_schema
query I
SELECT COUNT(*) FROM information_schema.schemata WHERE catalog_name = 'remote';
----
0

# The stub catalog still appears in duckdb_databases (not hidden)
# This is a DuckDB limitation - storage extensions can't hide the primary attachment
query I
SELECT COUNT(*) FROM duckdb_databases() WHERE database_name = 'remote';
----
1

# Attempting to query the stub catalog should fail with a helpful error message
statement error
SELECT * FROM remote.main.numbers;
----
PostHog: 'remote' is a stub catalog with no tables. Use 'remote_<catalog>' instead

# Cleanup: detach all catalogs
statement ok
DETACH remote_memory;

statement ok
DETACH remote_system;

statement ok
DETACH remote_temp;

statement ok
DETACH remote;

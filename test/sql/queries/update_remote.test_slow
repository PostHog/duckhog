# name: test/sql/queries/update_remote.test_slow
# description: UPDATE on remote DuckLake table
# group: [queries]

require duckhog

require-env FLIGHT_HOST

require-env FLIGHT_PORT

require-env DUCKHOG_USER

require-env DUCKHOG_PASSWORD

statement ok
ATTACH 'hog:ducklake?user=${DUCKHOG_USER}&password=${DUCKHOG_PASSWORD}&flight_server=grpc+tls://${FLIGHT_HOST}:${FLIGHT_PORT}&tls_skip_verify=true' AS remote_flight;

statement ok
DROP SCHEMA IF EXISTS remote_flight.update_remote CASCADE;

statement ok
CREATE SCHEMA remote_flight.update_remote;

statement ok
CREATE TABLE remote_flight.update_remote.t(i INT, j INT DEFAULT 99);

statement ok
INSERT INTO remote_flight.update_remote.t VALUES (1, 10), (2, 20), (3, 30);

query I
UPDATE remote_flight.update_remote.t SET i = i + 10 WHERE i = 1;
----
1

query II
SELECT i, j FROM remote_flight.update_remote.t ORDER BY i;
----
2	20
3	30
11	10

statement error
UPDATE remote_flight.update_remote.t SET j = DEFAULT WHERE i = 2;
----
SET DEFAULT is not yet supported for updates of a DuckLake table

query I
SELECT j FROM remote_flight.update_remote.t WHERE i = 2;
----
20

query I
UPDATE remote_flight.update_remote.t SET j = 99 WHERE i = 2;
----
1

query I
UPDATE remote_flight.update_remote.t SET i = i + 100, j = j + 1;
----
3

query II
SELECT i, j FROM remote_flight.update_remote.t ORDER BY i;
----
102	100
103	31
111	11

query I
UPDATE remote_flight.update_remote.t SET i = i + 1 WHERE i = -1;
----
0

statement ok
BEGIN;

query I
UPDATE remote_flight.update_remote.t SET j = 777 WHERE i = 102;
----
1

statement ok
ROLLBACK;

query I
SELECT j FROM remote_flight.update_remote.t WHERE i = 102;
----
100

statement ok
BEGIN;

query I
UPDATE remote_flight.update_remote.t SET j = 888 WHERE i = 102;
----
1

statement ok
COMMIT;

query I
SELECT j FROM remote_flight.update_remote.t WHERE i = 102;
----
888

statement ok
CREATE TABLE remote_flight.update_remote.side(i INT, new_j INT, bump INT);

statement ok
INSERT INTO remote_flight.update_remote.side VALUES (102, 5000, 1), (103, 6000, 5), (999, 7000, 7);

query I
UPDATE remote_flight.update_remote.t AS tgt
SET j = src.new_j, i = tgt.i + src.bump
FROM remote_flight.update_remote.side AS src
WHERE tgt.i = src.i;
----
2

query II
SELECT i, j FROM remote_flight.update_remote.t ORDER BY i;
----
103	5000
108	6000
111	11

statement ok
INSERT INTO remote_flight.update_remote.side VALUES (111, 9000, 0);

query I
UPDATE remote_flight.update_remote.t AS tgt
SET j = side.new_j
FROM remote_flight.update_remote.side AS side
WHERE tgt.i = side.i AND tgt.i = 111;
----
1

query I
SELECT j FROM remote_flight.update_remote.t WHERE i = 111;
----
9000

# name: test/sql/queries/truncate_remote.test_slow
# description: TRUNCATE on remote DuckLake table
# group: [queries]

require duckhog

require-env FLIGHT_HOST

require-env FLIGHT_PORT

require-env DUCKHOG_USER

require-env DUCKHOG_PASSWORD

statement ok
ATTACH 'hog:ducklake?user=${DUCKHOG_USER}&password=${DUCKHOG_PASSWORD}&flight_server=grpc+tls://${FLIGHT_HOST}:${FLIGHT_PORT}&tls_skip_verify=true' AS remote_flight;

statement ok
DROP SCHEMA IF EXISTS remote_flight.truncate_remote CASCADE;

statement ok
CREATE SCHEMA remote_flight.truncate_remote;

statement ok
CREATE TABLE remote_flight.truncate_remote.t(i INT, j INT);

statement ok
INSERT INTO remote_flight.truncate_remote.t VALUES (1, 10), (2, 20), (3, 30);

# --- Basic TRUNCATE ---

statement ok
TRUNCATE TABLE remote_flight.truncate_remote.t;

query I
SELECT count(*) FROM remote_flight.truncate_remote.t;
----
0

# --- TRUNCATE on empty table ---

statement ok
TRUNCATE TABLE remote_flight.truncate_remote.t;

query I
SELECT count(*) FROM remote_flight.truncate_remote.t;
----
0

# --- Re-insert after TRUNCATE ---

statement ok
INSERT INTO remote_flight.truncate_remote.t VALUES (4, 40), (5, 50);

query II
SELECT i, j FROM remote_flight.truncate_remote.t ORDER BY i;
----
4	40
5	50

# --- TRUNCATE in transaction with ROLLBACK ---

statement ok
BEGIN;

statement ok
TRUNCATE TABLE remote_flight.truncate_remote.t;

statement ok
ROLLBACK;

query I
SELECT count(*) FROM remote_flight.truncate_remote.t;
----
2

# --- TRUNCATE in transaction with COMMIT ---

statement ok
BEGIN;

statement ok
TRUNCATE TABLE remote_flight.truncate_remote.t;

statement ok
COMMIT;

query I
SELECT count(*) FROM remote_flight.truncate_remote.t;
----
0

# --- TRUNCATE and re-insert multiple times ---

statement ok
INSERT INTO remote_flight.truncate_remote.t VALUES (10, 100);

statement ok
TRUNCATE TABLE remote_flight.truncate_remote.t;

statement ok
INSERT INTO remote_flight.truncate_remote.t VALUES (20, 200), (30, 300);

query II
SELECT i, j FROM remote_flight.truncate_remote.t ORDER BY i;
----
20	200
30	300

# --- TRUNCATE preserves schema (columns still work) ---

statement ok
TRUNCATE TABLE remote_flight.truncate_remote.t;

statement ok
INSERT INTO remote_flight.truncate_remote.t VALUES (1, 2);

query II
SELECT i, j FROM remote_flight.truncate_remote.t;
----
1	2

# --- Error: TRUNCATE non-existent table ---

statement error
TRUNCATE TABLE remote_flight.truncate_remote.no_such_table;

# --- Error: TRUNCATE after DROP ---

statement ok
CREATE TABLE remote_flight.truncate_remote.t_drop(x INT);

statement ok
DROP TABLE remote_flight.truncate_remote.t_drop;

statement error
TRUNCATE TABLE remote_flight.truncate_remote.t_drop;

# --- Cleanup ---

statement ok
DROP SCHEMA remote_flight.truncate_remote CASCADE;

# name: test/sql/queries/insert_returning_remote.test_slow
# description: INSERT ... RETURNING on remote DuckLake table
# group: [queries]

require duckhog

require-env FLIGHT_HOST

require-env FLIGHT_PORT

require-env DUCKHOG_USER

require-env DUCKHOG_PASSWORD

statement ok
ATTACH 'hog:ducklake?user=${DUCKHOG_USER}&password=${DUCKHOG_PASSWORD}&flight_server=grpc+tls://${FLIGHT_HOST}:${FLIGHT_PORT}&tls_skip_verify=true' AS remote_flight;

statement ok
DROP SCHEMA IF EXISTS remote_flight.roadmap_rm15 CASCADE;

statement ok
CREATE SCHEMA remote_flight.roadmap_rm15;

# ============================================================
# Basic RETURNING *
# ============================================================

statement ok
CREATE TABLE remote_flight.roadmap_rm15.t(i INT, v VARCHAR);

query IT
INSERT INTO remote_flight.roadmap_rm15.t VALUES (1, 'hello') RETURNING *;
----
1	hello

# --- Verify data actually persisted ---

query IT
SELECT i, v FROM remote_flight.roadmap_rm15.t;
----
1	hello

# ============================================================
# RETURNING single column
# ============================================================

query I
INSERT INTO remote_flight.roadmap_rm15.t VALUES (2, 'world') RETURNING i;
----
2

query T
INSERT INTO remote_flight.roadmap_rm15.t VALUES (3, 'foo') RETURNING v;
----
foo

# ============================================================
# RETURNING with expression
# ============================================================

query I
INSERT INTO remote_flight.roadmap_rm15.t VALUES (4, 'bar') RETURNING i * 10;
----
40

query T
INSERT INTO remote_flight.roadmap_rm15.t VALUES (5, 'baz') RETURNING upper(v);
----
BAZ

query I
INSERT INTO remote_flight.roadmap_rm15.t VALUES (6, 'qux') RETURNING i + 100 AS computed;
----
106

# ============================================================
# RETURNING multiple rows
# ============================================================

query IT
INSERT INTO remote_flight.roadmap_rm15.t VALUES (10, 'a'), (20, 'b'), (30, 'c') RETURNING *;
----
10	a
20	b
30	c

query I
INSERT INTO remote_flight.roadmap_rm15.t VALUES (40, 'x'), (50, 'y') RETURNING i;
----
40
50

# ============================================================
# RETURNING with NULL values
# ============================================================

query IT
INSERT INTO remote_flight.roadmap_rm15.t VALUES (NULL, NULL) RETURNING *;
----
NULL	NULL

query IT
INSERT INTO remote_flight.roadmap_rm15.t VALUES (99, NULL) RETURNING *;
----
99	NULL

# ============================================================
# RETURNING from multi-column table
# ============================================================

statement ok
CREATE TABLE remote_flight.roadmap_rm15.multi(a INT, b VARCHAR, c DOUBLE, d BOOLEAN);

query ITRI
INSERT INTO remote_flight.roadmap_rm15.multi VALUES (1, 'test', 3.14, true) RETURNING *;
----
1	test	3.14	true

query TR
INSERT INTO remote_flight.roadmap_rm15.multi VALUES (2, 'more', 2.71, false) RETURNING b, c;
----
more	2.71

# ============================================================
# RETURNING in transaction with ROLLBACK
# ============================================================

statement ok
BEGIN;

query IT
INSERT INTO remote_flight.roadmap_rm15.t VALUES (999, 'txn_row') RETURNING *;
----
999	txn_row

statement ok
ROLLBACK;

# Row should not exist after rollback
query I
SELECT COUNT(*) FROM remote_flight.roadmap_rm15.t WHERE i = 999;
----
0

# ============================================================
# RETURNING in transaction with COMMIT
# ============================================================

statement ok
BEGIN;

query IT
INSERT INTO remote_flight.roadmap_rm15.t VALUES (888, 'committed') RETURNING *;
----
888	committed

statement ok
COMMIT;

query T
SELECT v FROM remote_flight.roadmap_rm15.t WHERE i = 888;
----
committed

# ============================================================
# Verify total row count
# ============================================================

query I
SELECT COUNT(*) FROM remote_flight.roadmap_rm15.t;
----
14

# ============================================================
# Cleanup
# ============================================================

statement ok
DROP SCHEMA remote_flight.roadmap_rm15 CASCADE;

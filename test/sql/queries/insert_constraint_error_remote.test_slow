# name: test/sql/queries/insert_constraint_error_remote.test_slow
# description: Constraint violation errors on remote tables
# group: [queries]

require duckhog

require-env FLIGHT_HOST

require-env FLIGHT_PORT

require-env DUCKHOG_USER

require-env DUCKHOG_PASSWORD

statement ok
ATTACH 'hog:memory?user=${DUCKHOG_USER}&password=${DUCKHOG_PASSWORD}&flight_server=grpc+tls://${FLIGHT_HOST}:${FLIGHT_PORT}&tls_skip_verify=true' AS remote;

statement ok
DROP SCHEMA IF EXISTS remote.insert_constraint_error CASCADE;

statement ok
CREATE SCHEMA remote.insert_constraint_error;

# ============================================================
# PRIMARY KEY violation
# ============================================================

statement ok
CREATE TABLE remote.insert_constraint_error.pk_table(i INT PRIMARY KEY, v INT);

statement ok
INSERT INTO remote.insert_constraint_error.pk_table VALUES (1, 10);

statement error
INSERT INTO remote.insert_constraint_error.pk_table VALUES (1, 20);
----
Constraint Error: PostHog: Update execution failed

# --- Data unchanged after failed insert ---

query II
SELECT i, v FROM remote.insert_constraint_error.pk_table;
----
1	10

# --- Different PK succeeds ---

statement ok
INSERT INTO remote.insert_constraint_error.pk_table VALUES (2, 20);

query II
SELECT i, v FROM remote.insert_constraint_error.pk_table ORDER BY i;
----
1	10
2	20

# ============================================================
# PK violation in batch (partial batch)
# ============================================================
# Batch with one conflicting row — entire batch should fail

statement error
INSERT INTO remote.insert_constraint_error.pk_table VALUES (3, 30), (1, 99), (4, 40);
----
Constraint Error

# --- None of the rows from the failed batch should be inserted ---

query I
SELECT COUNT(*) FROM remote.insert_constraint_error.pk_table;
----
2

# ============================================================
# PK violation in transaction
# ============================================================

statement ok
BEGIN;

statement error
INSERT INTO remote.insert_constraint_error.pk_table VALUES (1, 999);
----
Constraint Error

statement ok
ROLLBACK;

# --- Original data intact ---

query II
SELECT i, v FROM remote.insert_constraint_error.pk_table ORDER BY i;
----
1	10
2	20

# ============================================================
# NOT NULL violation
# ============================================================

statement ok
CREATE TABLE remote.insert_constraint_error.nn_table(id INT NOT NULL, name VARCHAR NOT NULL);

statement ok
INSERT INTO remote.insert_constraint_error.nn_table VALUES (1, 'valid');

statement error
INSERT INTO remote.insert_constraint_error.nn_table VALUES (NULL, 'oops');
----
Constraint Error

statement error
INSERT INTO remote.insert_constraint_error.nn_table VALUES (2, NULL);
----
Constraint Error

# --- Only the valid row exists ---

query IT
SELECT id, name FROM remote.insert_constraint_error.nn_table;
----
1	valid

# ============================================================
# UNIQUE constraint violation
# ============================================================

statement ok
CREATE TABLE remote.insert_constraint_error.uniq_table(code VARCHAR UNIQUE, val INT);

statement ok
INSERT INTO remote.insert_constraint_error.uniq_table VALUES ('A', 1);

statement error
INSERT INTO remote.insert_constraint_error.uniq_table VALUES ('A', 2);
----
Constraint Error

# --- Different code succeeds ---

statement ok
INSERT INTO remote.insert_constraint_error.uniq_table VALUES ('B', 2);

query TI
SELECT code, val FROM remote.insert_constraint_error.uniq_table ORDER BY code;
----
A	1
B	2

# ============================================================
# Multiple constraint violations: verify error, data intact
# ============================================================

# Try several bad inserts in a row — table should remain unchanged

statement error
INSERT INTO remote.insert_constraint_error.pk_table VALUES (1, 1);
----
Constraint Error

statement error
INSERT INTO remote.insert_constraint_error.pk_table VALUES (2, 2);
----
Constraint Error

statement error
INSERT INTO remote.insert_constraint_error.pk_table VALUES (1, 1);
----
Constraint Error

query I
SELECT COUNT(*) FROM remote.insert_constraint_error.pk_table;
----
2

# ============================================================
# Successful insert after constraint error (connection still good)
# ============================================================

statement ok
INSERT INTO remote.insert_constraint_error.pk_table VALUES (100, 1000);

query II
SELECT i, v FROM remote.insert_constraint_error.pk_table WHERE i = 100;
----
100	1000

# ============================================================
# Cleanup
# ============================================================

statement ok
DROP SCHEMA IF EXISTS remote.insert_constraint_error CASCADE;

# name: test/sql/queries/control_plane.test_slow
# description: Integration tests for control plane session creation
# group: [queries]
# Requires both control_plane_server.py and Duckling (Go) running

require duckhog

# This file is intentionally guarded: unlike direct Flight integration tests (which are guarded by FLIGHT_HOST/FLIGHT_PORT),
# these tests also require a control plane HTTP server to be listening.
require-env CONTROL_PLANE_HOST

require-env CONTROL_PLANE_PORT

# Connect via control plane (default path)
# Control plane returns flight endpoint, extension connects to Flight server
statement ok
ATTACH 'hog:memory?token=demo&control_plane=http://${CONTROL_PLANE_HOST}:${CONTROL_PLANE_PORT}' AS cp_test;

# Verify we can query through the connection
query I
SELECT value FROM cp_test.main.test_data;
----
1

# Query a larger table
query II
SELECT id, name FROM cp_test.main.numbers WHERE id <= 3 ORDER BY id;
----
1	item_1
2	item_2
3	item_3

# Clean up
statement ok
DETACH cp_test;

# Test with session token override
# The control plane returns a session_token that should be used instead of the original token
statement ok
ATTACH 'hog:memory?token=test-token&control_plane=http://${CONTROL_PLANE_HOST}:${CONTROL_PLANE_PORT}' AS session_test;

query I
SELECT value FROM session_test.main.test_data;
----
1

statement ok
DETACH session_test;

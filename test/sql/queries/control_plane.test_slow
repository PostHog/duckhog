# name: test/sql/queries/control_plane.test_slow
# description: Integration tests for direct Flight username/password auth
# group: [queries]

require duckhog

require-env FLIGHT_HOST

require-env FLIGHT_PORT

require-env DUCKHOG_USER

require-env DUCKHOG_PASSWORD

statement ok
ATTACH 'hog:memory?user=${DUCKHOG_USER}&password=${DUCKHOG_PASSWORD}&flight_server=grpc+tls://${FLIGHT_HOST}:${FLIGHT_PORT}' AS cp_test;

# Verify we can query through the connection
query I
SELECT CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END FROM cp_test.main.pg_type;
----
1

# Query another compatibility table
query I
SELECT CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END FROM cp_test.main.pg_namespace;
----
1

# Clean up
statement ok
DETACH cp_test;

# Wrong credentials should fail at query time
statement ok
ATTACH 'hog:memory?user=bad&password=bad&flight_server=grpc+tls://${FLIGHT_HOST}:${FLIGHT_PORT}' AS session_test;

statement error
SELECT COUNT(*) FROM session_test.main.pg_type;
----
invalid username or password

statement ok
DETACH session_test;

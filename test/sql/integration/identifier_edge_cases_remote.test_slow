# name: test/sql/integration/identifier_edge_cases_remote.test_slow
# description: SQL injection & identifier quoting edge cases
# group: [integration]

#
# Tests DuckHog's SQL generation paths:
# - arrow_stream.cpp:Produce() — builds SELECT with quoted identifiers
# - posthog_sql_utils.cpp:BuildInsertSQL — builds INSERT with QuoteIdent
# - posthog_dml_rewriter.cpp — catalog name substitution

require duckhog

require-env FLIGHT_HOST

require-env FLIGHT_PORT

require-env DUCKHOG_USER

require-env DUCKHOG_PASSWORD

statement ok
ATTACH 'hog:ducklake?user=${DUCKHOG_USER}&password=${DUCKHOG_PASSWORD}&flight_server=grpc+tls://${FLIGHT_HOST}:${FLIGHT_PORT}&tls_skip_verify=true' AS remote_flight;

statement ok
DROP SCHEMA IF EXISTS remote_flight.ident_test CASCADE;

statement ok
CREATE SCHEMA remote_flight.ident_test;

# ============================================================
# Column names that are reserved words
# ============================================================

statement ok
CREATE TABLE remote_flight.ident_test.reserved_cols("select" INT, "from" VARCHAR, "where" DOUBLE);

statement ok
INSERT INTO remote_flight.ident_test.reserved_cols VALUES (1, 'hello', 3.14);

query ITR
SELECT "select", "from", "where" FROM remote_flight.ident_test.reserved_cols;
----
1	hello	3.14

# UPDATE with reserved word column names
query I
UPDATE remote_flight.ident_test.reserved_cols SET "from" = 'world' WHERE "select" = 1;
----
1

query T
SELECT "from" FROM remote_flight.ident_test.reserved_cols;
----
world

# DELETE with reserved word in WHERE
statement ok
INSERT INTO remote_flight.ident_test.reserved_cols VALUES (2, 'delete_me', 0.0);

query I
DELETE FROM remote_flight.ident_test.reserved_cols WHERE "select" = 2;
----
1

# ============================================================
# Column names with spaces
# ============================================================

statement ok
CREATE TABLE remote_flight.ident_test.spaced_cols("my column" INT, "another col" VARCHAR);

statement ok
INSERT INTO remote_flight.ident_test.spaced_cols VALUES (1, 'test');

query IT
SELECT "my column", "another col" FROM remote_flight.ident_test.spaced_cols;
----
1	test

query I
UPDATE remote_flight.ident_test.spaced_cols SET "another col" = 'updated' WHERE "my column" = 1;
----
1

query T
SELECT "another col" FROM remote_flight.ident_test.spaced_cols;
----
updated

# ============================================================
# Table name with spaces
# ============================================================

statement ok
CREATE TABLE remote_flight.ident_test."my table"(id INT, val VARCHAR);

statement ok
INSERT INTO remote_flight.ident_test."my table" VALUES (1, 'spaced');

query IT
SELECT id, val FROM remote_flight.ident_test."my table";
----
1	spaced

query I
UPDATE remote_flight.ident_test."my table" SET val = 'updated' WHERE id = 1;
----
1

query I
DELETE FROM remote_flight.ident_test."my table" WHERE id = 1;
----
1

# ============================================================
# Column names with special characters
# ============================================================

statement ok
CREATE TABLE remote_flight.ident_test.special_chars("col-dash" INT, "col.dot" VARCHAR);

statement ok
INSERT INTO remote_flight.ident_test.special_chars VALUES (1, 'test');

query IT
SELECT "col-dash", "col.dot" FROM remote_flight.ident_test.special_chars;
----
1	test

# ============================================================
# Values with single quotes (SQL injection vector for ToSQLString)
# ============================================================

statement ok
CREATE TABLE remote_flight.ident_test.quotes(id INT, val VARCHAR);

statement ok
INSERT INTO remote_flight.ident_test.quotes VALUES (1, 'it''s a test');

query IT
SELECT id, val FROM remote_flight.ident_test.quotes;
----
1	it's a test

statement ok
INSERT INTO remote_flight.ident_test.quotes VALUES (2, 'O''Brien');

query T
SELECT val FROM remote_flight.ident_test.quotes WHERE id = 2;
----
O'Brien

statement ok
INSERT INTO remote_flight.ident_test.quotes VALUES (3, '''fully quoted''');

query T
SELECT val FROM remote_flight.ident_test.quotes WHERE id = 3;
----
'fully quoted'

# --- Value that looks like SQL injection ---

statement ok
INSERT INTO remote_flight.ident_test.quotes VALUES (4, '1''); DROP TABLE remote_flight.ident_test.quotes; --');

query I
SELECT COUNT(*) FROM remote_flight.ident_test.quotes;
----
4

query T
SELECT val FROM remote_flight.ident_test.quotes WHERE id = 4;
----
1'); DROP TABLE remote_flight.ident_test.quotes; --

# ============================================================
# Values with backslashes
# ============================================================

statement ok
INSERT INTO remote_flight.ident_test.quotes VALUES (5, 'back\slash');

query T
SELECT val FROM remote_flight.ident_test.quotes WHERE id = 5;
----
back\slash

statement ok
INSERT INTO remote_flight.ident_test.quotes VALUES (6, 'double\\backslash');

query T
SELECT val FROM remote_flight.ident_test.quotes WHERE id = 6;
----
double\\backslash

# ============================================================
# Schema name with special characters
# ============================================================

statement ok
CREATE SCHEMA remote_flight."schema with spaces";

statement ok
CREATE TABLE remote_flight."schema with spaces".t(id INT);

statement ok
INSERT INTO remote_flight."schema with spaces".t VALUES (42);

query I
SELECT id FROM remote_flight."schema with spaces".t;
----
42

statement ok
DROP SCHEMA remote_flight."schema with spaces" CASCADE;

# ============================================================
# Mixed case identifiers
# ============================================================

statement ok
CREATE TABLE remote_flight.ident_test."MixedCase"("CamelCol" INT, lower_col VARCHAR);

statement ok
INSERT INTO remote_flight.ident_test."MixedCase" VALUES (1, 'test');

query IT
SELECT "CamelCol", lower_col FROM remote_flight.ident_test."MixedCase";
----
1	test

# ============================================================
# Very long identifier name
# ============================================================

statement ok
CREATE TABLE remote_flight.ident_test.long_ident("this_is_a_very_long_column_name_that_exceeds_typical_limits_aaaa" INT);

statement ok
INSERT INTO remote_flight.ident_test.long_ident VALUES (1);

query I
SELECT "this_is_a_very_long_column_name_that_exceeds_typical_limits_aaaa" FROM remote_flight.ident_test.long_ident;
----
1

# ============================================================
# Column name with double quotes (tests arrow_stream.cpp Produce() quoting)
# ============================================================

# BUG: arrow_stream.cpp:Produce() wraps column names in " but does NOT escape
# internal " characters. A column named col"quote gets sent as:
#   SELECT "col"quote" FROM ...
# which is a syntax error on the remote side.
#
# This is a DuckHog bug — Produce() needs to escape " as "" inside identifiers.
# Until fixed, tables with " in column names will fail on SELECT.

statement ok
CREATE TABLE remote_flight.ident_test.dquote("col""quote" INT);

statement ok
INSERT INTO remote_flight.ident_test.dquote VALUES (99);

statement error
SELECT "col""quote" FROM remote_flight.ident_test.dquote;
----
syntax error

# ============================================================
# Cleanup
# ============================================================

statement ok
DROP SCHEMA remote_flight.ident_test CASCADE;

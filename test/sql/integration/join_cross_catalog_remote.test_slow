# name: test/sql/integration/join_cross_catalog_remote.test_slow
# description: Cross-catalog and local/remote JOINs
# group: [integration]

require duckhog

require-env FLIGHT_HOST

require-env FLIGHT_PORT

require-env DUCKHOG_USER

require-env DUCKHOG_PASSWORD

# --- Attach DuckLake and memory remote catalogs ---

statement ok
ATTACH 'hog:ducklake?user=${DUCKHOG_USER}&password=${DUCKHOG_PASSWORD}&flight_server=grpc+tls://${FLIGHT_HOST}:${FLIGHT_PORT}&tls_skip_verify=true' AS remote_flight;

statement ok
ATTACH 'hog:memory?user=${DUCKHOG_USER}&password=${DUCKHOG_PASSWORD}&flight_server=grpc+tls://${FLIGHT_HOST}:${FLIGHT_PORT}&tls_skip_verify=true' AS remote_mem;

statement ok
DROP SCHEMA IF EXISTS remote_flight.cross_cat CASCADE;

statement ok
CREATE SCHEMA remote_flight.cross_cat;

# Clean up memory catalog tables from prior runs
statement ok
DROP TABLE IF EXISTS remote_mem.customers;

statement ok
DROP TABLE IF EXISTS remote_mem.from_ducklake;

# ============================================================
# Setup: tables in DuckLake, memory remote, and local
# ============================================================

statement ok
CREATE TABLE remote_flight.cross_cat.orders(order_id INT, customer_id INT, amount DOUBLE);

statement ok
INSERT INTO remote_flight.cross_cat.orders VALUES
    (1, 100, 50.0),
    (2, 100, 75.0),
    (3, 200, 120.0),
    (4, 300, 30.0);

statement ok
CREATE TABLE remote_mem.customers(customer_id INT, name VARCHAR);

statement ok
INSERT INTO remote_mem.customers VALUES
    (100, 'alice'),
    (200, 'bob'),
    (400, 'dave');

# Local in-memory table
statement ok
CREATE TABLE local_products(product_id INT, label VARCHAR);

statement ok
INSERT INTO local_products VALUES (1, 'widget'), (2, 'gadget');

# ============================================================
# JOIN between remote table and local table
# ============================================================

statement ok
CREATE TABLE local_order_notes(order_id INT, note VARCHAR);

statement ok
INSERT INTO local_order_notes VALUES (1, 'rush'), (3, 'fragile'), (99, 'orphan');

query ITT
SELECT o.order_id, o.amount, n.note
FROM remote_flight.cross_cat.orders o
INNER JOIN local_order_notes n ON o.order_id = n.order_id
ORDER BY o.order_id;
----
1	50.0	rush
3	120.0	fragile

query ITT
SELECT o.order_id, o.amount, n.note
FROM remote_flight.cross_cat.orders o
LEFT JOIN local_order_notes n ON o.order_id = n.order_id
ORDER BY o.order_id;
----
1	50.0	rush
2	75.0	NULL
3	120.0	fragile
4	30.0	NULL

# ============================================================
# JOIN between two different remote catalogs (ducklake + memory)
# ============================================================

# Cross-catalog JOIN between two explicitly attached remote catalogs.
query ITRI
SELECT c.customer_id, c.name, o.amount, o.order_id
FROM remote_mem.customers c
INNER JOIN remote_flight.cross_cat.orders o ON c.customer_id = o.customer_id
ORDER BY o.order_id;
----
100	alice	50.0	1
100	alice	75.0	2
200	bob	120.0	3

# ============================================================
# INSERT...SELECT from local table to remote table
# ============================================================

statement ok
CREATE TABLE local_source(x INT, v VARCHAR);

statement ok
INSERT INTO local_source VALUES (10, 'from_local'), (20, 'from_local');

statement ok
CREATE TABLE remote_flight.cross_cat.from_local(x INT, v VARCHAR);

statement ok
INSERT INTO remote_flight.cross_cat.from_local SELECT * FROM local_source;

query IT
SELECT x, v FROM remote_flight.cross_cat.from_local ORDER BY x;
----
10	from_local
20	from_local

# ============================================================
# INSERT...SELECT from one remote catalog to another
# Works with explicit single-catalog attaches.
# ============================================================

statement ok
CREATE TABLE remote_mem.from_ducklake(order_id INT, amount DOUBLE);

statement ok
INSERT INTO remote_mem.from_ducklake
    SELECT order_id, amount FROM remote_flight.cross_cat.orders WHERE amount > 50;

query IR
SELECT order_id, amount FROM remote_mem.from_ducklake ORDER BY order_id;
----
2	75.0
3	120.0

# ============================================================
# Subquery referencing both remote catalogs
# ============================================================

query IR
SELECT order_id, amount
FROM remote_flight.cross_cat.orders
WHERE customer_id IN (SELECT customer_id FROM remote_mem.customers WHERE name = 'alice')
ORDER BY order_id;
----
1	50.0
2	75.0

# ============================================================
# Subquery with local + single remote works fine
# ============================================================

statement ok
CREATE TABLE local_cust_ids(customer_id INT);

statement ok
INSERT INTO local_cust_ids VALUES (100), (200);

query IR
SELECT order_id, amount
FROM remote_flight.cross_cat.orders
WHERE customer_id IN (SELECT customer_id FROM local_cust_ids)
ORDER BY order_id;
----
1	50.0
2	75.0
3	120.0

statement ok
DROP TABLE local_cust_ids;

# ============================================================
# Three-way join: local + ducklake + memory
# ============================================================

statement ok
CREATE TABLE local_tags(order_id INT, tag VARCHAR);

statement ok
INSERT INTO local_tags VALUES (1, 'priority'), (2, 'normal'), (3, 'priority');

query TTRI
SELECT c.name, lt.tag, o.amount, o.order_id
FROM remote_flight.cross_cat.orders o
INNER JOIN remote_mem.customers c ON o.customer_id = c.customer_id
INNER JOIN local_tags lt ON o.order_id = lt.order_id
ORDER BY o.order_id;
----
alice	priority	50.0	1
alice	normal	75.0	2
bob	priority	120.0	3

# ============================================================
# Cleanup
# ============================================================

statement ok
DROP TABLE IF EXISTS local_products;

statement ok
DROP TABLE IF EXISTS local_order_notes;

statement ok
DROP TABLE IF EXISTS local_source;

statement ok
DROP TABLE IF EXISTS local_tags;

statement ok
DROP TABLE IF EXISTS remote_mem.customers;

statement ok
DROP TABLE IF EXISTS remote_mem.from_ducklake;

statement ok
DROP SCHEMA remote_flight.cross_cat CASCADE;

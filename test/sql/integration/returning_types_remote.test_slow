# name: test/sql/integration/returning_types_remote.test_slow
# description: INSERT ... RETURNING is not supported; DELETE RETURNING limitation documented
# group: [integration]

require duckhog

require-env FLIGHT_HOST

require-env FLIGHT_PORT

require-env DUCKHOG_USER

require-env DUCKHOG_PASSWORD

statement ok
ATTACH 'hog:ducklake?user=${DUCKHOG_USER}&password=${DUCKHOG_PASSWORD}&flight_server=grpc+tls://${FLIGHT_HOST}:${FLIGHT_PORT}&tls_skip_verify=true' AS remote_flight;

statement ok
DROP SCHEMA IF EXISTS remote_flight.ret_types CASCADE;

statement ok
CREATE SCHEMA remote_flight.ret_types;

# ============================================================
# INSERT ... RETURNING is not supported (DuckLake limitation)
# ============================================================

statement ok
CREATE TABLE remote_flight.ret_types.int_types(ti TINYINT, si SMALLINT, i INTEGER, bi BIGINT);

statement error
INSERT INTO remote_flight.ret_types.int_types VALUES (42, 1000, 100000, 9999999999) RETURNING *;
----
INSERT ... RETURNING is not supported

statement ok
CREATE TABLE remote_flight.ret_types.float_types(f FLOAT, d DOUBLE);

statement error
INSERT INTO remote_flight.ret_types.float_types VALUES (3.14, 2.718281828) RETURNING *;
----
INSERT ... RETURNING is not supported

statement ok
CREATE TABLE remote_flight.ret_types.bool_type(b BOOLEAN);

statement error
INSERT INTO remote_flight.ret_types.bool_type VALUES (true) RETURNING *;
----
INSERT ... RETURNING is not supported

statement ok
CREATE TABLE remote_flight.ret_types.varchar_type(v VARCHAR);

statement error
INSERT INTO remote_flight.ret_types.varchar_type VALUES ('hello') RETURNING *;
----
INSERT ... RETURNING is not supported

statement ok
CREATE TABLE remote_flight.ret_types.mixed(id INT, name VARCHAR, score DOUBLE, active BOOLEAN);

statement error
INSERT INTO remote_flight.ret_types.mixed VALUES (1, 'alice', 95.5, true) RETURNING *;
----
INSERT ... RETURNING is not supported

statement ok
CREATE TABLE remote_flight.ret_types.date_type(d DATE);

statement error
INSERT INTO remote_flight.ret_types.date_type VALUES ('2024-06-15') RETURNING *;
----
INSERT ... RETURNING is not supported

statement ok
CREATE TABLE remote_flight.ret_types.ts_type(ts TIMESTAMP);

statement error
INSERT INTO remote_flight.ret_types.ts_type VALUES ('2024-06-15 12:00:00') RETURNING *;
----
INSERT ... RETURNING is not supported

# ============================================================
# DELETE RETURNING — broken on all remote catalogs
# DuckHog wraps DELETE RETURNING in a CTE:
#   WITH __duckhog_deleted_rows AS (DELETE ... RETURNING *) SELECT ...
# Duckgres rejects this because DuckDB CTEs require SELECT, not DELETE.
# This is a DuckHog/Duckgres limitation.
# ============================================================

statement ok
CREATE TABLE remote_flight.ret_types.del_ret(id INT, name VARCHAR);

statement ok
INSERT INTO remote_flight.ret_types.del_ret VALUES (1, 'alice');

statement error
DELETE FROM remote_flight.ret_types.del_ret WHERE id = 1 RETURNING *;
----
CTE needs a SELECT

# ============================================================
# Unsigned integer types via memory catalog — also blocked
# ============================================================

statement ok
ATTACH 'hog:memory?user=${DUCKHOG_USER}&password=${DUCKHOG_PASSWORD}&flight_server=grpc+tls://${FLIGHT_HOST}:${FLIGHT_PORT}&tls_skip_verify=true' AS remote_ret_mem;

statement ok
DROP TABLE IF EXISTS remote_ret_mem.unsigned_ret;

statement ok
CREATE TABLE remote_ret_mem.unsigned_ret(uti UTINYINT, usi USMALLINT, ui UINTEGER, ubi UBIGINT);

statement error
INSERT INTO remote_ret_mem.unsigned_ret VALUES (255, 65535, 4294967295, 18446744073709551615) RETURNING *;
----
INSERT ... RETURNING is not supported

# ============================================================
# Cleanup
# ============================================================

statement ok
DROP TABLE IF EXISTS remote_ret_mem.unsigned_ret;

statement ok
DROP SCHEMA remote_flight.ret_types CASCADE;

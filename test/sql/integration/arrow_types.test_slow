# name: test/sql/integration/arrow_types.test_slow
# description: Type and metadata coverage via Flight SQL using compatibility tables
# group: [integration]

# Tests in this file require a running Flight SQL server
# Run: ./scripts/test-servers.sh start before executing

require duckhog

require-env FLIGHT_HOST

require-env FLIGHT_PORT

require-env DUCKHOG_USER

require-env DUCKHOG_PASSWORD

statement ok
ATTACH 'hog:memory?user=${DUCKHOG_USER}&password=${DUCKHOG_PASSWORD}&flight_server=grpc+tls://${FLIGHT_HOST}:${FLIGHT_PORT}&tls_skip_verify=true' AS remote;

# Basic type-bearing table should be readable.
query I
SELECT CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END FROM remote.main.pg_type;
----
1

# String column coverage (typname) via projection.
query I
SELECT CASE WHEN SUM(CASE WHEN typname IS NOT NULL THEN 1 ELSE 0 END) > 0 THEN 1 ELSE 0 END
FROM remote.main.pg_type;
----
1

# Numeric column coverage (oid) via aggregation.
query I
SELECT CASE WHEN COUNT(*) >= COUNT(oid) THEN 1 ELSE 0 END
FROM remote.main.pg_type;
----
1

# Metadata should expose expected columns for compatibility tables.
query I
SELECT CASE WHEN COUNT(*) = 1 THEN 1 ELSE 0 END
FROM information_schema.columns
WHERE table_catalog = 'remote'
  AND table_schema = 'main'
  AND table_name = 'pg_type'
  AND column_name = 'oid';
----
1

query I
SELECT CASE WHEN COUNT(*) = 1 THEN 1 ELSE 0 END
FROM information_schema.columns
WHERE table_catalog = 'remote'
  AND table_schema = 'main'
  AND table_name = 'pg_type'
  AND column_name = 'typname';
----
1

# name: test/sql/integration/update_remote.test_slow
# description: UPDATE on remote DuckLake table
# group: [integration]

require duckhog

require-env FLIGHT_HOST

require-env FLIGHT_PORT

require-env DUCKHOG_USER

require-env DUCKHOG_PASSWORD

statement ok
ATTACH 'hog:ducklake?user=${DUCKHOG_USER}&password=${DUCKHOG_PASSWORD}&flight_server=grpc+tls://${FLIGHT_HOST}:${FLIGHT_PORT}&tls_skip_verify=true' AS remote_flight;

statement ok
DROP SCHEMA IF EXISTS remote_flight.update_remote CASCADE;

statement ok
CREATE SCHEMA remote_flight.update_remote;

statement ok
CREATE TABLE remote_flight.update_remote.t(i INT, j INT DEFAULT 99);

statement ok
INSERT INTO remote_flight.update_remote.t VALUES (1, 10), (2, 20), (3, 30);

query I
UPDATE remote_flight.update_remote.t SET i = i + 10 WHERE i = 1;
----
1

query II
SELECT i, j FROM remote_flight.update_remote.t ORDER BY i;
----
2	20
3	30
11	10

statement error
UPDATE remote_flight.update_remote.t SET j = DEFAULT WHERE i = 2;
----
SET DEFAULT is not yet supported for updates of a DuckLake table

query I
SELECT j FROM remote_flight.update_remote.t WHERE i = 2;
----
20

query I
UPDATE remote_flight.update_remote.t SET j = 99 WHERE i = 2;
----
1

query I
UPDATE remote_flight.update_remote.t SET i = i + 100, j = j + 1;
----
3

query II
SELECT i, j FROM remote_flight.update_remote.t ORDER BY i;
----
102	100
103	31
111	11

query I
UPDATE remote_flight.update_remote.t SET i = i + 1 WHERE i = -1;
----
0

statement ok
BEGIN;

query I
UPDATE remote_flight.update_remote.t SET j = 777 WHERE i = 102;
----
1

statement ok
ROLLBACK;

query I
SELECT j FROM remote_flight.update_remote.t WHERE i = 102;
----
100

statement ok
BEGIN;

query I
UPDATE remote_flight.update_remote.t SET j = 888 WHERE i = 102;
----
1

statement ok
COMMIT;

query I
SELECT j FROM remote_flight.update_remote.t WHERE i = 102;
----
888

statement ok
CREATE TABLE remote_flight.update_remote.side(i INT, new_j INT, bump INT);

statement ok
INSERT INTO remote_flight.update_remote.side VALUES (102, 5000, 1), (103, 6000, 5), (999, 7000, 7);

query I
UPDATE remote_flight.update_remote.t AS tgt
SET j = src.new_j, i = tgt.i + src.bump
FROM remote_flight.update_remote.side AS src
WHERE tgt.i = src.i;
----
2

query II
SELECT i, j FROM remote_flight.update_remote.t ORDER BY i;
----
103	5000
108	6000
111	11

statement ok
INSERT INTO remote_flight.update_remote.side VALUES (111, 9000, 0);

query I
UPDATE remote_flight.update_remote.t AS tgt
SET j = side.new_j
FROM remote_flight.update_remote.side AS side
WHERE tgt.i = side.i AND tgt.i = 111;
----
1

query I
SELECT j FROM remote_flight.update_remote.t WHERE i = 111;
----
9000

# ============================================================
# UPDATE SET column to NULL
# ============================================================

statement ok
CREATE TABLE remote_flight.update_remote.nulls(id INT, val VARCHAR);

statement ok
INSERT INTO remote_flight.update_remote.nulls VALUES (1, 'hello'), (2, 'world');

query I
UPDATE remote_flight.update_remote.nulls SET val = NULL WHERE id = 1;
----
1

query IT
SELECT id, val FROM remote_flight.update_remote.nulls ORDER BY id;
----
1	NULL
2	world

# ============================================================
# UPDATE with CASE expression
# ============================================================

statement ok
CREATE TABLE remote_flight.update_remote.case_test(id INT, score INT, grade VARCHAR);

statement ok
INSERT INTO remote_flight.update_remote.case_test VALUES
    (1, 95, NULL), (2, 82, NULL), (3, 65, NULL), (4, 45, NULL);

query I
UPDATE remote_flight.update_remote.case_test
SET grade = CASE
    WHEN score >= 90 THEN 'A'
    WHEN score >= 80 THEN 'B'
    WHEN score >= 70 THEN 'C'
    ELSE 'F'
END;
----
4

query IIT
SELECT id, score, grade FROM remote_flight.update_remote.case_test ORDER BY id;
----
1	95	A
2	82	B
3	65	F
4	45	F

# ============================================================
# UPDATE on empty table
# ============================================================

statement ok
CREATE TABLE remote_flight.update_remote.empty_upd(x INT);

query I
UPDATE remote_flight.update_remote.empty_upd SET x = 1;
----
0

query I
UPDATE remote_flight.update_remote.empty_upd SET x = 1 WHERE x = 1;
----
0

# ============================================================
# Large batch UPDATE
# ============================================================

statement ok
CREATE TABLE remote_flight.update_remote.large(seq INT, val INT);

statement ok
INSERT INTO remote_flight.update_remote.large SELECT i, 0 FROM range(1000) t(i);

query I
UPDATE remote_flight.update_remote.large SET val = seq * 2;
----
1000

query I
SELECT SUM(val) FROM remote_flight.update_remote.large;
----
999000

query I
SELECT COUNT(*) FROM remote_flight.update_remote.large WHERE val = seq * 2;
----
1000

# ============================================================
# UPDATE with subquery in SET clause
# ============================================================

statement ok
CREATE TABLE remote_flight.update_remote.scores(id INT, score INT);

statement ok
INSERT INTO remote_flight.update_remote.scores VALUES (1, 100), (2, 200), (3, 300);

statement ok
CREATE TABLE remote_flight.update_remote.adjustments(adj INT);

statement ok
INSERT INTO remote_flight.update_remote.adjustments VALUES (10);

query I
UPDATE remote_flight.update_remote.scores
SET score = score + (SELECT adj FROM remote_flight.update_remote.adjustments);
----
3

query II
SELECT id, score FROM remote_flight.update_remote.scores ORDER BY id;
----
1	110
2	210
3	310

# ============================================================
# UPDATE with IN clause in WHERE
# ============================================================

query I
UPDATE remote_flight.update_remote.scores SET score = 0 WHERE id IN (1, 3);
----
2

query II
SELECT id, score FROM remote_flight.update_remote.scores ORDER BY id;
----
1	0
2	210
3	0

# ============================================================
# Cleanup
# ============================================================

statement ok
DROP SCHEMA remote_flight.update_remote CASCADE;

# name: test/sql/integration/insert_returning_remote.test_slow
# description: INSERT ... RETURNING is not supported (DuckLake limitation)
# group: [integration]

require duckhog

require-env FLIGHT_HOST

require-env FLIGHT_PORT

require-env DUCKHOG_USER

require-env DUCKHOG_PASSWORD

statement ok
ATTACH 'hog:ducklake?user=${DUCKHOG_USER}&password=${DUCKHOG_PASSWORD}&flight_server=grpc+tls://${FLIGHT_HOST}:${FLIGHT_PORT}&tls_skip_verify=true' AS remote_flight;

statement ok
DROP SCHEMA IF EXISTS remote_flight.roadmap_rm15 CASCADE;

statement ok
CREATE SCHEMA remote_flight.roadmap_rm15;

statement ok
CREATE TABLE remote_flight.roadmap_rm15.t(i INT, v VARCHAR);

# ============================================================
# INSERT ... RETURNING is not supported (DuckLake limitation)
# DuckLake does not support RETURNING on any DML verb.
# The previous chunk-echo implementation was semantically wrong
# (echoed client input, not server state).
# ============================================================

statement error
INSERT INTO remote_flight.roadmap_rm15.t VALUES (1, 'hello') RETURNING *;
----
INSERT ... RETURNING is not supported

statement error
INSERT INTO remote_flight.roadmap_rm15.t VALUES (2, 'world') RETURNING i;
----
INSERT ... RETURNING is not supported

statement error
INSERT INTO remote_flight.roadmap_rm15.t VALUES (3, 'foo') RETURNING v;
----
INSERT ... RETURNING is not supported

statement error
INSERT INTO remote_flight.roadmap_rm15.t VALUES (4, 'bar') RETURNING i * 10;
----
INSERT ... RETURNING is not supported

statement error
INSERT INTO remote_flight.roadmap_rm15.t VALUES (5, 'baz') RETURNING upper(v);
----
INSERT ... RETURNING is not supported

statement error
INSERT INTO remote_flight.roadmap_rm15.t VALUES (10, 'a'), (20, 'b'), (30, 'c') RETURNING *;
----
INSERT ... RETURNING is not supported

statement error
INSERT INTO remote_flight.roadmap_rm15.t VALUES (NULL, NULL) RETURNING *;
----
INSERT ... RETURNING is not supported

# ============================================================
# Multi-column table
# ============================================================

statement ok
CREATE TABLE remote_flight.roadmap_rm15.multi(a INT, b VARCHAR, c DOUBLE, d BOOLEAN);

statement error
INSERT INTO remote_flight.roadmap_rm15.multi VALUES (1, 'test', 3.14, true) RETURNING *;
----
INSERT ... RETURNING is not supported

statement error
INSERT INTO remote_flight.roadmap_rm15.multi VALUES (2, 'more', 2.71, false) RETURNING b, c;
----
INSERT ... RETURNING is not supported

# ============================================================
# RETURNING in transaction â€” error should not affect transaction
# ============================================================

statement ok
BEGIN;

statement error
INSERT INTO remote_flight.roadmap_rm15.t VALUES (999, 'txn_row') RETURNING *;
----
INSERT ... RETURNING is not supported

statement ok
ROLLBACK;

# ============================================================
# Plain INSERT (no RETURNING) still works
# ============================================================

statement ok
INSERT INTO remote_flight.roadmap_rm15.t VALUES (1, 'hello');

query IT
SELECT i, v FROM remote_flight.roadmap_rm15.t;
----
1	hello

# ============================================================
# Cleanup
# ============================================================

statement ok
DROP SCHEMA remote_flight.roadmap_rm15 CASCADE;

# name: test/sql/integration/multi_catalog_schemas.test_slow
# description: Test catalog-less attach does not auto-attach additional catalogs
# group: [integration]

# Tests in this file require a running Flight SQL server
# Run: ./scripts/test-servers.sh start before executing

require duckhog

require-env FLIGHT_HOST

require-env FLIGHT_PORT

require-env DUCKHOG_USER

require-env DUCKHOG_PASSWORD

# When no catalog is specified in the connection string, the extension
# attaches a single catalog under the requested alias. It should not
# auto-attach additional <alias>_<catalog> entries.
statement ok
ATTACH 'hog:?user=${DUCKHOG_USER}&password=${DUCKHOG_PASSWORD}&flight_server=grpc+tls://${FLIGHT_HOST}:${FLIGHT_PORT}&tls_skip_verify=true' AS remote;

# Primary alias should exist
query I
SELECT COUNT(*) FROM duckdb_databases() WHERE database_name = 'remote';
----
1

# Auto-attached alias entries should not exist
query I
SELECT COUNT(*) FROM duckdb_databases() WHERE database_name LIKE 'remote_%';
----
0

# Primary alias should expose schemas/tables (i.e. not be a stub catalog)
query I
SELECT CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END
FROM information_schema.schemata
WHERE catalog_name = 'remote';
----
1

statement ok
DETACH remote;
